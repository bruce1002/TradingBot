<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingView Binance Bot - Dashboard</title>
    <link rel="stylesheet" href="/static/dashboard.css">
</head>
<body>
    <!-- é é¢ Header -->
    <header class="page-header">
        <h1>TradingView Binance Bot Dashboard</h1>
        <div class="user-info">
            <span>ç™»å…¥å¸³è™Ÿï¼š{{ user_email or "æœªçŸ¥" }}</span>
            <button id="logout-btn">ç™»å‡º</button>
        </div>
    </header>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main class="page-main">
        <!-- å€‰ä½è¡¨æ ¼å€å¡Š -->
        <section class="positions-section">
            <div class="positions-header">
                <h2>ðŸ“’ Positions</h2>
                <div class="positions-tabs">
                    <button class="tab-button active" data-tab="bot">Bot Positions</button>
                    <button class="tab-button" data-tab="binance">Binance Live Positions</button>
                    <button class="tab-button" data-tab="signals">Signals</button>
                    <button class="tab-button" data-tab="bots">Bots</button>
                </div>
            </div>
            
            <!-- Trailing Settings -->
            <div class="trailing-settings">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                    <!-- LONG Settings -->
                    <div style="border: 1px solid var(--border-color, #333); padding: 15px; border-radius: 8px; background: var(--card-bg, #1e1e1e);">
                        <h4 style="margin: 0 0 15px 0; color: var(--pnl-positive, #00ff88);">LONG Positions</h4>
                        <label class="setting-item">
                            <span>PnL% threshold (%):</span>
                            <input type="number" id="profit-threshold-long" step="0.1" min="0" class="setting-input">
                        </label>
                        <label class="setting-item">
                            <span>Lock ratio:</span>
                            <input type="number" id="lock-ratio-long" step="0.05" min="0" max="1" class="setting-input">
                        </label>
                        <label class="setting-item">
                            <span>Base SL (%):</span>
                            <input type="number" id="base-sl-long" step="0.1" min="0" class="setting-input">
                        </label>
                    </div>
                    
                    <!-- SHORT Settings -->
                    <div style="border: 1px solid var(--border-color, #333); padding: 15px; border-radius: 8px; background: var(--card-bg, #1e1e1e);">
                        <h4 style="margin: 0 0 15px 0; color: var(--pnl-negative, #ff4444);">SHORT Positions</h4>
                        <label class="setting-item">
                            <span>PnL% threshold (%):</span>
                            <input type="number" id="profit-threshold-short" step="0.1" min="0" class="setting-input">
                        </label>
                        <label class="setting-item">
                            <span>Lock ratio:</span>
                            <input type="number" id="lock-ratio-short" step="0.05" min="0" max="1" class="setting-input">
                        </label>
                        <label class="setting-item">
                            <span>Base SL (%):</span>
                            <input type="number" id="base-sl-short" step="0.1" min="0" class="setting-input">
                        </label>
                    </div>
                </div>
                <button id="save-trailing-settings" class="action-btn">Save</button>
                <div class="setting-note">
                    <small>Note: Dynamic Stop and Auto close are always enabled by default.</small>
                </div>
            </div>
            
            <p class="subtitle">
                <span class="tag-dyn">Dynamic Stop</span>
                vs
                <span class="tag-base">Base Stop-Loss</span>
            </p>

            <!-- Bot Positions -->
            <div id="bot-positions-container" class="positions-container active">
                <!-- Filter and Delete Section -->
                <div class="positions-filter-section">
                    <h3>Filter & Manage Positions</h3>
                    <div class="filter-row">
                        <label>
                            Symbol:
                            <select id="filter-symbol">
                                <option value="">All</option>
                            </select>
                        </label>
                        <label>
                            Status:
                            <select id="filter-status">
                                <option value="">All</option>
                                <option value="OPEN">OPEN</option>
                                <option value="CLOSED">CLOSED</option>
                                <option value="ERROR">ERROR</option>
                            </select>
                        </label>
                        <label>
                            From Date:
                            <input type="date" id="filter-start-date">
                        </label>
                        <label>
                            To Date:
                            <input type="date" id="filter-end-date">
                        </label>
                        <button id="apply-filter-btn" class="action-btn">Apply Filter</button>
                        <button id="clear-filter-btn" class="btn-secondary">Clear</button>
                    </div>
                    <div class="delete-actions-row">
                        <label>
                            Delete positions older than (days):
                            <input type="number" id="delete-days" min="1" max="365" value="30" style="width: 80px;">
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="delete-include-error">
                            <span>Include ERROR positions</span>
                        </label>
                        <button id="delete-old-positions-btn" class="btn-danger">Delete Old Positions</button>
                        <button id="clear-error-positions-btn" class="btn-danger">Clear All ERROR Positions</button>
                        <button id="bot-export-excel" class="action-btn">Export Excel</button>
                    </div>
                </div>
                
                <div id="positions-table-container">
                    <!-- è¼‰å…¥ä¸­... -->
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        è¼‰å…¥ä¸­...
                    </div>
                </div>
                
                <!-- æ—¥æœŸç¯©é¸å’Œçµ±è¨ˆå€å¡Šï¼ˆåœ¨è¡¨æ ¼ä¸‹æ–¹ï¼‰ -->
                <div class="bot-stats-section">
                    <!-- æ—¥æœŸç¯©é¸å’ŒåŒ¯å‡ºæŒ‰éˆ• -->
                    <div id="bot-positions-filter" class="bot-filter-row">
                        <label>From: <input type="date" id="bot-start-date"></label>
                        <label>To: <input type="date" id="bot-end-date"></label>
                        <button id="bot-apply-filter" class="action-btn">Apply</button>
                    </div>
                    
                    <!-- çµ±è¨ˆè³‡è¨Š -->
                    <div id="bot-positions-stats" class="bot-stats-row">
                        <!-- ç”± JS æ³¨å…¥å…§å®¹ -->
                    </div>
                </div>
            </div>

            <!-- Binance Live Positions -->
            <div id="binance-positions-container" class="positions-container">
                <!-- Portfolio Summary and Controls -->
                <div class="portfolio-controls" style="margin-bottom: 20px; padding: 20px; background: var(--card-bg, #1e1e1e); border-radius: 8px; border: 1px solid var(--border-color, #333);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: var(--text-primary, #fff);">Portfolio Summary</h3>
                        <button id="close-all-positions-btn" class="btn-danger" style="padding: 8px 16px;">Close All Positions</button>
                    </div>
                    <div id="portfolio-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <div style="color: var(--text-muted, #888); font-size: 12px; margin-bottom: 5px;">Total Unrealized PnL</div>
                            <div id="total-pnl" style="font-size: 24px; font-weight: bold; color: var(--text-primary, #fff);">-</div>
                        </div>
                        <div>
                            <div style="color: var(--text-muted, #888); font-size: 12px; margin-bottom: 5px;">Position Count</div>
                            <div id="position-count" style="font-size: 24px; font-weight: bold; color: var(--text-primary, #fff);">-</div>
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <div style="color: var(--text-muted, #888); font-size: 12px;">Max PnL Reached</div>
                                <button id="reset-max-pnl-btn" class="action-btn" style="padding: 4px 8px; font-size: 11px; line-height: 1;" title="é‡ç½® Max PnL Reached">Reset</button>
                            </div>
                            <div id="max-pnl-reached" style="font-size: 24px; font-weight: bold; color: var(--text-primary, #fff);">-</div>
                        </div>
                    </div>
                    
                    <!-- Portfolio Trailing Stop Controls -->
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color, #333);">
                        <h4 style="margin: 0 0 15px 0; color: var(--text-primary, #fff);">Portfolio Trailing Stop</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">
                            <label class="setting-item" style="display: flex; flex-direction: column;">
                                <span>Enable Auto Sell:</span>
                                <input type="checkbox" id="portfolio-trailing-enabled" style="width: auto; margin-top: 5px;">
                            </label>
                            <label class="setting-item" style="display: flex; flex-direction: column;">
                                <span>Target PnL (USDT):</span>
                                <input type="number" id="portfolio-target-pnl" step="0.01" min="0" class="setting-input" placeholder="e.g., 100">
                            </label>
                            <label class="setting-item" style="display: flex; flex-direction: column;">
                                <span>Lock Ratio:</span>
                                <input type="number" id="portfolio-lock-ratio" step="0.05" min="0" max="1" class="setting-input" placeholder="e.g., 0.65">
                            </label>
                            <button id="save-portfolio-trailing-btn" class="action-btn" style="padding: 10px 20px;">Save Config</button>
                        </div>
                        <div style="margin-top: 10px; color: var(--text-muted, #888); font-size: 12px;">
                            <small>When total PnL reaches Target, max PnL is recorded. If PnL falls to (Max PnL Ã— Lock Ratio), all positions will be closed automatically.</small>
                        </div>
                    </div>
                </div>
                
                <div id="binance-table-container">
                    <!-- è¼‰å…¥ä¸­... -->
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        è¼‰å…¥ä¸­...
                    </div>
                </div>
            </div>

            <!-- Signals -->
            <div id="signals-container" class="positions-container">
                <!-- Signal Configs Section -->
                <div id="signal-configs-section">
                    <div class="bots-header-row">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button id="toggle-signal-configs-section-btn" class="toggle-section-btn" style="background: none; border: none; color: var(--text-primary, #fff); font-size: 16px; cursor: pointer; padding: 4px 8px;">â–¼</button>
                            <h2 class="section-title">TradingView Signal Configs <span id="signal-configs-count"></span></h2>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button id="clear-signal-logs-btn" class="btn-danger">Clear Signal Logs</button>
                            <button id="btn-open-signal-form" class="action-btn">New Signal</button>
                        </div>
                    </div>
                    
                    <!-- Signal Create/Edit Form (Initially Hidden) -->
                    <div id="signal-form-container" class="bot-form-card" style="display:none;">
                        <h3 id="signal-form-title">Create New Signal</h3>
                        <form id="signal-create-form">
                            <!-- First Row: Name / Signal Key -->
                            <div class="form-row">
                                <label>
                                    Name <span class="required">*</span>
                                    <input type="text" id="signal-name" required placeholder="Signal name" />
                                </label>
                                <label>
                                    Signal Key <span class="required">*</span>
                                    <input type="text" id="signal-key" required placeholder="Unique signal key" />
                                </label>
                            </div>

                            <!-- Second Row: Symbol Hint / Timeframe Hint -->
                            <div class="form-row">
                                <label>
                                    Symbol Hint
                                    <input type="text" id="signal-symbol-hint" placeholder="e.g. BTCUSDT" />
                                </label>
                                <label>
                                    Timeframe
                                    <input type="text" id="signal-timeframe-hint" placeholder="e.g. 15m / 1h" />
                                </label>
                            </div>

                            <!-- Third Row: Description / Enabled -->
                            <div class="form-row">
                                <label>
                                    Description
                                    <input type="text" id="signal-description" placeholder="Signal description" />
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="signal-enabled" checked />
                                    <span>Enabled</span>
                                </label>
                            </div>

                            <!-- TradingView Alert Template -->
                            <div class="form-row">
                                <label style="flex: 1 1 100%;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                        <span>TradingView Alert Template</span>
                                        <button type="button" id="btn-copy-alert-template" class="action-btn" style="padding: 4px 12px; font-size: 12px; height: auto;">
                                            <span id="copy-btn-text">Copy</span>
                                        </button>
                                    </div>
                                    <textarea id="signal-alert-template" readonly rows="8" style="width: 100%; padding: 8px; background-color: var(--tbl-bg); border: 1px solid var(--tbl-border); color: var(--tbl-text); border-radius: 4px; font-family: monospace; font-size: 12px;"></textarea>
                                    <small style="color: var(--tbl-muted); font-size: 11px;">è¤‡è£½æ­¤ JSON åˆ° TradingView Alert è¨­å®šä¸­</small>
                                </label>
                            </div>

                            <!-- Form Actions -->
                            <div class="form-actions">
                                <button type="submit" class="action-btn" id="signal-form-submit-btn">Save</button>
                                <button type="button" id="btn-cancel-signal-form" class="action-btn">Cancel</button>
                            </div>

                            <div id="signal-form-error" class="form-error" style="display:none;"></div>
                        </form>
                    </div>
                    
                    <!-- Signal Configs Table -->
                    <div id="signal-configs-table-container">
                        <!-- è¼‰å…¥ä¸­... -->
                        <div class="loading-state">
                            <div class="loading-spinner"></div>
                            è¼‰å…¥ä¸­...
                        </div>
                    </div>
                </div>
                
                <!-- Signal Logs (ä¿ç•™åŽŸæœ‰åŠŸèƒ½) -->
                <div id="signals-table-section" style="margin-top: 32px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <button id="toggle-signal-logs-section-btn" class="toggle-section-btn" style="background: none; border: none; color: var(--text-primary, #fff); font-size: 16px; cursor: pointer; padding: 4px 8px;">â–¼</button>
                        <h3 class="section-title">Signal Logs <span id="signals-count"></span></h3>
                    </div>
                    <div id="signals-table-container">
                        <!-- è¼‰å…¥ä¸­... -->
                        <div class="loading-state">
                            <div class="loading-spinner"></div>
                            è¼‰å…¥ä¸­...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bots -->
            <div id="bots-container" class="positions-container">
                <!-- Bots Header with New Bot Button -->
                <div class="bots-header-row">
                    <h2 class="section-title">Bots</h2>
                    <div style="display: flex; gap: 10px;">
                        <!-- Bulk Update Invest Amount Section -->
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="number" step="0.01" min="0" id="bulk-update-invest-amount" placeholder="Investment (USDT)" style="width: 150px; padding: 6px 10px; background-color: var(--tbl-bg); border: 1px solid var(--tbl-border); color: var(--tbl-text); border-radius: 4px;" />
                            <button id="btn-bulk-update-invest-amount" class="action-btn" style="padding: 6px 16px;">Update All Bots</button>
                        </div>
                        <button id="btn-open-bot-form" class="action-btn">New Bot</button>
                    </div>
                </div>
                
                <!-- Bulk Update Result Message -->
                <div id="bulk-update-result" style="display: none; margin: 10px 0; padding: 10px; border-radius: 4px;"></div>
                
                <!-- Bot Create Form (Initially Hidden) -->
                <div id="bot-form-container" class="bot-form-card" style="display:none;">
                    <h3>Create New Bot</h3>
                    <form id="bot-create-form">
                        <!-- First Row: Name / Bot Key -->
                        <div class="form-row">
                            <label>
                                Name <span class="required">*</span>
                                <input type="text" id="bot-name" required placeholder="Bot name" />
                            </label>
                            <label>
                                Bot Key <span class="required">*</span>
                                <input type="text" id="bot-key" required placeholder="Unique bot key" />
                            </label>
                        </div>

                        <!-- Second Row: Symbol / Qty / Max Invest USDT / Leverage -->
                        <div class="form-row">
                            <label>
                                Symbol <span class="required">*</span>
                                <input list="symbol-suggestions" id="bot-symbol" required placeholder="BTCUSDT" />
                                <datalist id="symbol-suggestions">
                                    <!-- JS will populate this -->
                                </datalist>
                            </label>
                            <label class="with-tooltip">
                                Qty
                                <input type="number" step="0.0001" min="0" id="bot-qty" placeholder="0.01" />
                                <span class="tooltip-icon" title="äº¤æ˜“æ•¸é‡ï¼ˆç•¶ Max Invest USDT æœªè¨­å®šæ™‚ä½¿ç”¨ï¼‰">?</span>
                            </label>
                            <label class="with-tooltip">
                                Max Invest (USDT)
                                <input type="number" step="0.01" min="0" id="bot-max-invest-usdt" placeholder="50.0" />
                                <span class="tooltip-icon" title="æœ€å¤§æŠ•è³‡é‡‘é¡ï¼ˆUSDTï¼‰ã€‚å¦‚æžœè¨­å®šï¼Œç³»çµ±æœƒæ ¹æ“šç•¶å‰åƒ¹æ ¼è‡ªå‹•è¨ˆç®— qtyï¼Œä¸”ä¸æœƒè¶…éŽæ­¤é‡‘é¡">?</span>
                            </label>
                            <label>
                                Leverage <span class="required">*</span>
                                <input type="number" step="1" min="1" max="125" id="bot-leverage" required placeholder="5" />
                            </label>
                        </div>

                        <!-- Third Row: Signal / Side Source -->
                        <div class="form-row">
                            <label>
                                Signal
                                <select id="bot-signal-id">
                                    <option value="">(None - independent bot)</option>
                                    <!-- JS will populate this -->
                                </select>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="bot-use-signal-side" checked />
                                <span>Use side from TradingView signal</span>
                            </label>
                            <label>
                                Fixed Side
                                <select id="bot-fixed-side">
                                    <option value="">(None - use signal side)</option>
                                    <option value="BUY">LONG (Buy)</option>
                                    <option value="SELL">SHORT (Sell)</option>
                                </select>
                            </label>
                        </div>

                        <!-- Fourth Row: Dynamic Stop Settings -->
                        <div class="form-row">
                            <label class="checkbox-label">
                                <input type="checkbox" id="bot-use-dynamic-stop" checked />
                                <span>Enable Dynamic Stop</span>
                                <span class="tooltip-icon" title="å‹¾é¸å¾Œï¼Œæ­¤ bot æœƒä½¿ç”¨å‹•æ…‹åœæï¼šé”åˆ°ç²åˆ©é–€æª»å¾Œï¼ŒéŽ–ä½éƒ¨åˆ†ç²åˆ©ä¸¦è¿½è¹¤åœåˆ©">?</span>
                            </label>
                            <label class="with-tooltip">
                                Dynamic Lock (%)
                                <input type="number" step="0.1" min="0" max="100" id="bot-trailing-callback-percent" placeholder="10.0" />
                                <span class="tooltip-icon" title="éŽ–åˆ©æ¯”ä¾‹ï¼šä¾‹å¦‚ 50% ä»£è¡¨ä¸€æ—¦é”åˆ°ç²åˆ©é–€æª»å¾Œï¼Œç³»çµ±æœƒéŽ–ä½å·²å¯¦ç¾ç²åˆ©çš„ä¸€åŠï¼Œåƒ¹æ ¼å›žæ’¤åˆ°è©²åƒ¹ä½æ™‚è§¸ç™¼åœæ">?</span>
                            </label>
                            <label class="with-tooltip">
                                Base SL (%)
                                <input type="number" step="0.1" min="0" max="100" id="bot-base-stop-loss-pct" placeholder="5.0" />
                                <span class="tooltip-icon" title="åŸºç¤Žåœæï¼šæœªé”æˆå‹•æ…‹åœåˆ©é–€æª»å‰ï¼Œè‹¥åƒ¹æ ¼åå‘è¶…éŽæ­¤ç™¾åˆ†æ¯”ï¼Œå‰‡è§¸ç™¼åœæ">?</span>
                            </label>
                        </div>

                        <!-- Fifth Row: Enabled -->
                        <div class="form-row">
                            <label class="checkbox-label">
                                <input type="checkbox" id="bot-enabled" checked />
                                <span>Enabled</span>
                            </label>
                        </div>

                        <!-- Form Actions -->
                        <div class="form-actions">
                            <button type="submit" class="action-btn">Create Bot</button>
                            <button type="button" id="btn-cancel-bot-form" class="action-btn">Cancel</button>
                        </div>

                        <div id="bot-form-error" class="form-error" style="display:none;"></div>
                    </form>
                </div>
                
                <div id="bots-table-container">
                    <!-- è¼‰å…¥ä¸­... -->
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        è¼‰å…¥ä¸­...
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Signal Detail Modal -->
    <div id="signal-detail-modal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Signal Detail</h3>
          <button id="signal-detail-close" class="modal-close">Ã—</button>
        </div>
        <div class="modal-body">
          <div class="modal-section">
            <h4>Metadata</h4>
            <pre id="signal-detail-meta"></pre>
          </div>
          <div class="modal-section">
            <h4>Raw Payload</h4>
            <pre id="signal-detail-raw"></pre>
          </div>
        </div>
      </div>
    </div>

    <!-- Bot Creation Confirmation Modal -->
    <div id="bot-confirm-modal" class="modal hidden">
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
          <h3>Confirm Bot Creation</h3>
          <button id="bot-confirm-close" class="modal-close">Ã—</button>
        </div>
        <div class="modal-body">
          <p style="margin-bottom: 20px; color: var(--tbl-text);">Please review the bot configuration before creating:</p>
          <div id="bot-confirm-details" style="background-color: var(--tbl-bg-alt); padding: 16px; border-radius: 6px; border: 1px solid var(--tbl-border);">
            <!-- Details will be populated by JavaScript -->
          </div>
        </div>
        <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--tbl-border);">
          <button id="bot-confirm-cancel" class="action-btn" style="background-color: var(--tbl-bg-alt); color: var(--tbl-text);">Cancel</button>
          <button id="bot-confirm-submit" class="action-btn">Confirm & Create</button>
        </div>
      </div>
    </div>

    <!-- JavaScript -->
    <script src="/static/dashboard.js"></script>
</body>
</html>
